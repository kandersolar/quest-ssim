#:include common.kv


#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDDropdownMenu kivymd.uix.menu.MDDropdownMenu
#:import MDDropDownItem kivymd.uix.dropdownitem.MDDropDownItem

<DiagramPlot>
    pos_hint: {"top":1}

<SSimScreen>:
    name: 'ssim'

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: 30

            Label:
                text: "Project Name:"
                color: C(hex_black)
                size_hint: (0.25, 1.0)

            TextInput:
                id: project_name
                text: "unnamed"
                multiline: False
                valign: "center"
                on_text: root.project.name = project_name.text

        BoxLayout:
            orientation: "horizontal"

            BoxLayout:
                orientation: "vertical"
                size_hint_x: 0.35
                padding: 5
                spacing: 5

                Button:
                    text: "read from file"
                    on_press: root.read_toml()

                BoxLayout:
                    orientation: "horizontal"
                    #size_hint: (1.0, 0.1)
                    spacing: 5

                    Button:
                        text: "save"
                        size_hint: (0.5, 1.0)
                        on_press: root.write_to_toml()

                    Button:
                        text: "save as"
                        size_hint: (0.5, 1.0)
                        on_press: root.write_as_toml()

                Button:
                    text: "select grid model"
                    on_press: root.select_grid_model()

                Button:
                    text: "select storage"
                    on_press: root.open_der_configuration()

                Button:
                    text: "configure loads"
                    on_press: root.open_load_configuration()

                Button:
                    text: "configure metrics"
                    on_press: root.open_metric_configuration()

                Button:
                    text: "Run"
                    on_press: root.do_run_simulation()

            BoxLayout:
                orientation: "vertical"
                id: plot_side_box
                size_hint_x: 0.65

                MDLabel
                    id: grid_model_label
                    size_hint_y: None
                    height: 25
                    text: "Grid Model:"

                DiagramPlot:
                    id: grid_diagram

                BoxLayout:
                    id: plt_controls
                    orientation: "horizontal"
                    size_hint_y: None
                    height: 30

                    MDLabel
                        id: show_bus_label
                        size_hint_x: None
                        width: 135
                        text: "Show Bus Labels"

                    CheckBox:
                        id: show_bus_labels
                        size_hint_x: None
                        width: 30
                        active: True
                        on_active: root.changed_show_bus_labels(self.active)

<DERConfigurationScreen>:
    name: "der-config"
    on_enter: root.load_project_data()

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            padding: 5
            size_hint: (1.0, 0.8)

            BoxLayout:
                orientation: "vertical"
                padding: 5

                Label:
                    text: "List of Defined Storage Assets"
                    size_hint: (1.0, 0.05)
                    color: 0,0,0,1

                ScrollView:
                    size_hint: (1.0, 0.75)
                    MDList:
                        id: ess_list

                Button:
                    size_hint: (1.0, 0.1)
                    text: "New Storage"
                    on_press: root.new_storage()

                Button:
                    id: delete_storage
                    size_hint: (1.0, 0.1)
                    text: "Delete Storage"

            BoxLayout:
                orientation: "vertical"
                padding: 5

                Label:
                    text: "List of Defined PV Assets"
                    size_hint: (1.0, 0.05)
                    color: 0,0,0,1

                ScrollView:
                    size_hint: (1.0, 0.75)
                    MDList:
                        id: pv_list

        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: 30

            Button:
                text: "back"
                on_press: root.manager.current = 'ssim'

            Button:
                text: "save"
                # Might need something different here to handle the
                on_press: root.manager.current = 'ssim'


<StorageListitem>:
    LeftCheckBox:
        id: selected

    IconRightWidget:
        id: edit
        icon: "pencil"

<PVListitem>:


<BusListItem>:

    LeftCheckBox:
        id: selected

<DroopTabContent@BoxLayout>
    orientation: "vertical"
    padding: 5

    TextFieldFloat:
        id: p_value
        hint_text: "P Droop"

    TextFieldFloat:
        id: q_value
        hint_text: "Q Droop"

    BoxLayout:
        size_hint: (1.0, 0.8)

<ConstPFTabContent@BoxLayout>
    orientation: "vertical"
    padding: 5

    TextFieldFloat:
        id: pf_value
        hint_text: "Power Factor Value"

    BoxLayout:
        size_hint: (1.0, 0.9)

<VoltVarTabContent>
    orientation: "vertical"
    size_hint: (1.0, 1.0)
    padding: 5

    BoxLayout:
        orientation: "horizontal"
        size_hint: 1.0, 0.07


        BoxLayout:
            orientation: "horizontal"

            MDLabel:
                id: x_label
                text: "Voltage (p.u.)"

            Button:
                id: sortbtn
                text: "Sort"
                size_hint_x: None
                width: 45
                pos_hint_y: 0.9
                on_release: root.on_sort_button()

        MDLabel:
            id: y_label
            text: "Reactive Power (kVAR)"

        Button:
            id: addbtn
            text: "+"
            size_hint_x: None
            width: 25
            pos_hint_y: 0.9
            on_release: root.on_add_button()

    XYGridView:
        id: grid
        size_hint: (1.0, 0.93)


<VoltWattTabContent>
    orientation: "vertical"
    size_hint: (1.0, 1.0)
    padding: 5

    BoxLayout:
        orientation: "horizontal"
        size_hint: 1.0, 0.07

        BoxLayout:
            orientation: "horizontal"

            MDLabel:
                id: x_label
                text: "Voltage (p.u.)"

            Button:
                id: sortbtn
                text: "Sort"
                size_hint_x: None
                width: 45
                pos_hint_y: 0.9
                on_release: root.on_sort_button()

        MDLabel:
            id: y_label
            text: "Watts (kW)"

        Button:
            id: addbtn
            text: "+"
            size_hint_x: None
            width: 25
            pos_hint_y: 0.9
            on_release: root.on_add_button()

    XYGridView:
        id: grid
        size_hint: (1.0, 0.93)

<VarWattTabContent>
    orientation: "vertical"
    size_hint: (1.0, 1.0)
    padding: 5

    BoxLayout:
        orientation: "horizontal"
        size_hint: 1.0, 0.07

        BoxLayout:
            orientation: "horizontal"

            MDLabel:
                id: x_label
                text: "Reactive Power (kVAR)"

            Button:
                id: sortbtn
                text: "Sort"
                size_hint_x: None
                width: 45
                pos_hint_y: 0.9
                on_release: root.on_sort_button()

        MDLabel:
            id: y_label
            text: "Watts (kW)"

        Button:
            id: addbtn
            text: "+"
            size_hint_x: None
            width: 25
            pos_hint_y: 0.9
            on_release: root.on_add_button()

    XYGridView:
        id: grid
        size_hint: (1.0, 0.93)


<VoltVarVarWattTabContent>
    orientation: "horizontal"
    size_hint: (1.0, 1.0)
    padding: 5

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1.0, 0.07

            BoxLayout:
                orientation: "horizontal"

                MDLabel:
                    id: x_label
                    text: "Voltage (p.u.)"

                Button:
                    id: sortbtn
                    text: "Sort"
                    size_hint_x: None
                    width: 45
                    pos_hint_y: 0.9
                    on_release: root.on_vv_sort_button()

            MDLabel:
                id: y_label
                text: "Reactive Power (kVAR)"

            Button:
                id: addbtn
                text: "+"
                size_hint_x: None
                width: 25
                pos_hint_y: 0.9
                on_release: root.on_add_vv_button()

        XYGridView:
            id: vv_grid
            size_hint: (1.0, 0.93)


    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            size_hint: 1.0, 0.07

            BoxLayout:
                orientation: "horizontal"

                MDLabel:
                    id: x_label
                    text: "Reactive Power (kVAR)"

                Button:
                    id: sortbtn
                    text: "Sort"
                    size_hint_x: None
                    width: 45
                    pos_hint_y: 0.9
                    on_release: root.on_vw_sort_button()

            MDLabel:
                id: y_label
                text: "Watts (kW)"

            Button:
                id: addbtn
                text: "+"
                size_hint_x: None
                width: 25
                pos_hint_y: 0.9
                on_release: root.on_add_vw_button()

        XYGridView:
            id: vw_grid
            size_hint: (1.0, 0.93)


<StorageControlConfigurationScreen>:
    name: "configure-storage-controls"
    on_enter: self.set_mode_label_text()

    BoxLayout:
        orientation: "vertical"
        padding: 5

        TextFieldPositivePercentage:
            id: min_soc
            hint_text: "Minimum State of Charge (%)"

        TextFieldPositivePercentage:
            id: max_soc
            hint_text: "Maximum State of Charge (%)"

        TextFieldPositivePercentage:
            id: init_soc
            hint_text: "Initial State of Charge (%)"

        Label:
            id: mode_label
            markup: True
            text: "Select a control mode for this storage asset:"
            color: C(hex_black)
            size_hint: (1.0, 0.05)

        BoxLayout:

            #orientation: "horizontal"
            size_hint: (1.0, 0.2)

            MDTabs:
                id: control_tabs
                on_tab_switch: root.on_tab_switch(*args)

                StorageControlModelTab:
                    id: droop_tab
                    title: "Droop"

                    DroopTabContent:
                        id: droop_tab_content

                StorageControlModelTab:
                    id: vv_tab
                    title: "Volt-Var"

                    VoltVarTabContent:
                        id: vv_tab_content

                StorageControlModelTab:
                    id: vw_tab
                    title: "Volt-Watt"

                    VoltWattTabContent:
                        id: vw_tab_content

                StorageControlModelTab:
                    id: var_watt_tab
                    title: "Var-Watt"

                    VarWattTabContent:
                        id: var_watt_tab_content

                StorageControlModelTab:
                    id: vv_vw_tab
                    title: "Volt-Var & Volt-Watt"

                    VoltVarVarWattTabContent:
                        id: vv_vw_tab_content

                StorageControlModelTab:
                    id: const_pf_tab
                    title: "Constant Power Factor"

                    ConstPFTabContent:
                        id: const_pf_tab_content

        BoxLayout:
            size_hint_y: None
            height: 30
            orientation: "horizontal"
            Button:
                text: "back"
                on_press: root.cancel()

            Button:
                text: "save"
                on_press: root.save()


<StorageConfigurationScreen>:
    name: "configure-storage"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"

            BoxLayout:
                orientation: "vertical"
                padding: 5

                TextFieldOpenDSSName:
                    id: device_name
                    hint_text: "Device Name"
                    helper_text_mode: "on_error"
                    helper_text: "invalid name"

                BoxLayout:
                    orientation: "vertical"

                    TextFieldPositiveFloat:
                        id: power_input
                        hint_text: "Storage Device Power (kW)"

                    MDScrollView:
                        EditableSetList:
                            id: power_list

                BoxLayout:
                    orientation: "vertical"

                    TextFieldPositiveFloat:
                        id: duration_input
                        hint_text: "Storage Device Duration (hours)"

                    MDScrollView:
                        EditableSetList:
                            id: duration_list

            BoxLayout:
                orientation: "vertical"
                spacing: 10
                MDLabel:
                    text: "Select possible busses"
                    size_hint: (1.0, 0.05)
                MDScrollView:
                    size_hint: (1.0, 0.83)
                    MDList:
                        size_hint_y: None
                        height: 0
                        id: bus_list

                BoxLayout:
                    size_hint: (1.0, 0.06)
                    orientation: "horizontal"
                    MDLabel:
                        id: required_label
                        text: "Required?"
                    MDSwitch:
                        #pos_hint: {"left":0.0,"top":0.0}
                        id: required
                        active: False

                Button:
                    text: "Edit Control Parameters"
                    size_hint: (1.0, 0.06)
                    on_press: root.edit_control_params()

        BoxLayout:
            size_hint_y: None
            height: 30
            orientation: "horizontal"
            Button:
                text: "back"
                on_press: root.cancel()

            Button:
                text: "save"
                on_press: root.save()


<LoadConfigurationScreen>:
    name: "load-config"

    BoxLayout:
        orientation: "vertical"

        Label:
            id: currMetriclabel
            text: "Defined Metrics"
            size_hint: 1.0, 0.05
            color: 0,0,0,1

        ScrollView:
            MDList:
                id: metriclist

        Button:
            text: "back"
            on_press: root.manager.current = 'ssim'

<MetricListItem>:

    bus: ' '

    IconRightWidget:
        id: trash_can
        icon: 'trash-can-outline'
        listItem: root

    IconLeftWidget:
        id: left_icon
        icon: 'chart-line'

<BusListItemWithCheckbox>:

    IconRightWidget:
        icon: root.icon

    LeftCheckbox:
        id: check
        listItem: root

<XYGridView>
    viewclass: 'XYGridViewItem'
    #size_hint: 0.5, 0.93
    RecycleBoxLayout:
        default_size: None, dp(32)
        default_size_hint: 1, None
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'
        multiselect: False
        touch_multiselect: False

<XYItemTextField>
    multiline: False

<XYGridViewItem>
    orientation: 'horizontal'
    #size_hint: 0.5, 0.05
    padding: 2

    XYItemTextField:
        id: x_field

    XYItemTextField:
        id: y_field

    Button:
        id: deletebtn
        text: "X"
        size_hint_x: None
        width: 25
        pos_hint_y: 0.9
        on_release: root.on_delete_button()

<MetricConfigurationScreen>:
    name: "metric-config"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            #cols: 3
            orientation: "horizontal"

            BoxLayout:
                orientation: "vertical"

                Label:
                    text: "Class of Metrics to Configure"
                    size_hint: 1.0, 0.05
                    color: 0,0,0,1

                ScrollView:

                    MDList:
                        id: metriclist

                        TwoLineIconListItem:
                            text: "Bus Voltages"
                            secondary_text: "set voltage targets by bus"
                            icon: "plus"
                            on_release: root.configure_voltage_metrics()

                        TwoLineIconListItem:
                            text: "Some other metric values"
                            secondary_text: "set ..."
                            icon: "plus"
                            on_release: root.configure_some_other_metrics()

            BoxLayout:
                orientation: "vertical"

                Label:
                    id: interlabel
                    text: "Metric Objects"
                    size_hint: 1.0, 0.05
                    color: 0,0,0,1

                BoxLayout:
                    orientation: "horizontal"
                    size_hint: None, None
                    size: self.parent.width, 10

                    Button:
                        id: btnSelectAll
                        text: "Select All"
                        size_hint: 0.5, None
                        size: self.parent.width, 10
                        on_release: root.select_all_metric_objects()
                        disabled: True

                    Button:
                        id: btnDeselectAll
                        text: "Deselect All"
                        size_hint: 0.5, None
                        size: self.parent.width, 10
                        on_release: root.deselect_all_metric_objects()
                        disabled: True

                ScrollView:
                    MDList:
                        id: interlist

            BoxLayout:
                orientation: "vertical"

                BoxLayout:
                    id: metricValueBox
                    orientation: "vertical"
                    size_hint_y: None
                    height: 320
                    disabled: True

                    Label:
                        id: metriclabel
                        text: "Metric Settings"
                        size_hint_y: None
                        height: 25
                        color: 0,0,0,1

                    BoxLayout:
                        id: metricSenseBox
                        orientation: "horizontal"
                        size_hint_y: None
                        height: 35
                        disabled: True

                        MDRaisedButton:
                            id: min_btn
                            selected: False
                            text: "Minimize"
                            size_hint: 0.33, None
                            #size: self.parent.width, 25
                            on_release: root.set_minimize_sense()

                        MDRaisedButton:
                            id: max_btn
                            selected: False
                            text: "Maximize"
                            size_hint: 0.33, None
                            #size: self.parent.width, 25
                            on_release: root.set_maximize_sense()

                        MDRaisedButton:
                            id: seek_btn
                            selected: False
                            text: "Seek Value"
                            size_hint: 0.33, None
                            #size: self.parent.width, 25
                            on_release: root.set_seek_value_sense()

                    TextFieldMultiFloat:
                        hint_text: "Lower Limit Value"
                        size_hint_y: None
                        height: 25
                        id: lowerLimitText

                    TextFieldMultiFloat:
                        hint_text: "Objective Value"
                        size_hint_y: None
                        height: 25
                        id: objectiveText

                    TextFieldMultiFloat:
                        hint_text: "Upper Limit Value"
                        size_hint_y: None
                        height: 25
                        id: upperLimitText

                    Button:
                        id: btnStore
                        text: "store"
                        size_hint_y: None
                        height: 25
                        on_release: root.store_metrics()
                        disabled: True

                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: 40

                    Label:
                        id: currMetriclabel
                        text: "Defined Metrics"
                        size_hint: 1.0, 0.05
                        color: 0,0,0,1

                    ScrollView:
                        MDList:
                            id: metriclist

        Button:
            text: "back"
            size_hint: 1.0, 0.05
            on_press: root.manager.current = 'ssim'

<RunSimulationScreen>:
    name: "run-sim"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            padding: 5

            BoxLayout:
                orientation: "vertical"
                padding: 5
                Label:
                    text: "Configurations that will be evaluated:"
                    size_hint_y: None
                    height: 50
                ScrollView:
                    canvas.before:
                        Color:
                            rgba: .5, .5, .5, 1
                        Line:
                            width: 2
                            rectangle: self.x, self.y, self.width, self.height
                    MDList:
                        id: config_list

            BoxLayout:
                orientation: "vertical"
                padding: 5
                spacing: 5
                Label:
                    text: "Total number of configurations 256 (128 completed)"
                    size_hint_y: None
                    height: 50
                Button:
                    text: "View Saved Results"
                Button:
                    text: "Resume"
                Button:
                    text: "Remove Configuration"
                Button:
                    text: "Go"
                    on_press: root.run_configurations()

        Button:
            text: "back"
            size_hint_y: None
            height: 100
            on_press: root.manager.current = 'ssim'


<EditableSetListItem>:

    IconRightWidget:
        id: delete
        icon: "trash-can-outline"


<ListItemWithCheckbox>:
    id: the_list_item
    markup: True

    LeftCheckbox:
        id: check
        active: True
        on_release:
            self.toggle_configuration_check(check)

    IconRightWidget:
        icon: 'trash-can-outline'
        theme_text_color: "Custom"
        text_color: 1, 0, 0, 1
        on_release:
            root.delete_item(the_list_item)

<SelectGridDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.dss"]

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)

<LoadSSIMTOMLDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.toml"]

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)

<SaveSSIMTOMLDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.toml"]
            dirselect: True
            on_selection: root.manage_filename_field()

        BoxLayout:
            size_hint_y: None
            height: 30
            orientation: "horizontal"

            Label:
                text: "Filename:"
                size_hint: 0.1, 1.0

            TextInput:
                id: filenamefield

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Save"
                on_release: root.save(filechooser.selection or [filechooser.path], filenamefield.text)

<MetricsNoGridPopupContent>:
    orientation: "vertical"
    Label:
        text: 'A grid model has not yet been selected.  Please return to the main screen and choose a grid model before attempting to set voltage metrics.'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2

    Button:
        id: mainScreenBtn
        text: 'Return to Main Screen'
        size_hint: 1, 0.2

<MessagePopupContent>:
    orientation: "vertical"
    Label:
        id: msg_label
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2

<MissingMetricValuesPopupContent>:
    orientation: "vertical"
    Label:
        text: 'Not all metric values have been properly specified.  Be sure to enter numbers for ""Limit"" and ""Objective"" and select a ""Sense"".'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2


<NoGridPopupContent>:
    Label:
        text: 'A grid model has not yet been selected.  Please return to the main screen and choose a grid model before continuing.'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2
