#:include common.kv


#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDDropdownMenu kivymd.uix.menu.MDDropdownMenu
#:import MDDropDownItem kivymd.uix.dropdownitem.MDDropDownItem

<SSimScreen>:
    name: 'ssim'
    bus_list: bus_list
    BoxLayout:
        orientation: "vertical"
        padding: 5
        spacing: 5

        BoxLayout:
            orientation: "horizontal"
            size_hint: (1.0, 0.5)

            Label:
                text: "Project Name:"
                color: C(hex_black)
                size_hint: (0.33, 1.0)

            TextInput:
                text: "unnamed"
                multiline: False
                valign: "center"

        Button:
            text: "save to file"
            on_press: root.write_toml()

        Button:
            text: "read from file"
            on_press: root.read_toml()

        Button:
            text: "select grid model"
            on_press: root.select_grid_model()

        Button:
            text: "select storage"
            on_press: root.open_der_configuration()

        Button:
            text: "configure loads"
            on_press: root.open_load_configuration()

        Button:
            text: "configure metrics"
            on_press: root.open_metric_configuration()

        Button:
            text: "Run"
            on_press: root.do_run_simulation()

        TextInput:
            id: bus_list
            multiline: True

<DERConfigurationScreen>:
    name: "der-config"
    on_enter: root.load_project_data()

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            padding: 5
            size_hint: (1.0, 0.8)

            BoxLayout:
                orientation: "vertical"
                padding: 5

                ScrollView:
                    size_hint: (1.0, 0.8)
                    MDList:
                        id: ess_list

                Button:
                    size_hint: (1.0, 0.1)
                    text: "New Storage"
                    on_press: root.new_storage()

                Button:
                    id: delete_storage
                    size_hint: (1.0, 0.1)
                    text: "Delete Storage"

            Button:
                text: "list of PV"


        BoxLayout:
            orientation: "horizontal"
            padding: 5
            spacing: 5
            size_hint: (1.0, 0.2)

            Button:
                height: 10
                text: "back"
                on_press: root.manager.current = 'ssim'

            Button:
                height: 10
                text: "save"
                # Might need something different here to handle the
                on_press: root.manager.current = 'ssim'


<StorageListitem>:
    LeftCheckBox:
        id: selected

    IconRightWidget:
        id: edit
        icon: "pencil"

<ResultsVariableListItemWithCheckbox>:
    id: results_variable_list
    markup: True

    LeftCheckBox:
        id: selected
        active: False
        on_release: root.toggle_selection()

<BusListItem>:

    LeftCheckBox:
        id: selected

<StorageControlConfigurationScreen>:
    name: "configure-storage-controls"
    on_enter: self.set_mode_label_text()

    BoxLayout:
        orientation: "vertical"

        TextFieldPositivePercentage:
            id: min_soc
            hint_text: "Minimum State of Charge (%)"

        TextFieldPositivePercentage:
            id: max_soc
            hint_text: "Maximum State of Charge (%)"

        TextFieldPositivePercentage:
            id: init_soc
            hint_text: "Initial State of Charge (%)"

        Label:
            id: mode_label
            markup: True
            text: "Select a control mode for this storage asset:"
            color: C(hex_black)
            size_hint: (1.0, 0.05)

        BoxLayout:
            orientation: "horizontal"
            size_hint: (1.0, 0.2)

            MDRaisedButton:
                id: droop_mode
                text: "Droop"
                md_bg_color: '#005376'
                on_press: root.set_droop_mode()

            MDRaisedButton:
                id: vv_mode
                text: "Volt-Var"
                md_bg_color: '#005376'
                on_press: root.set_volt_var_mode()

            MDRaisedButton:
                id: vw_mode
                text: "Volt-Watt"
                md_bg_color: '#005376'
                on_press: root.set_volt_watt_mode()

            MDRaisedButton:
                id: var_watt_mode
                text: "Var-Watt"
                md_bg_color: '#005376'
                on_press: root.set_var_watt_mode()

            MDRaisedButton:
                id: vv_vw_mode
                text: "Volt-Var & Volt-Watt"
                md_bg_color: '#005376'
                on_press: root.set_volt_var_and_volt_watt_mode()

            MDRaisedButton:
                id: const_pf_mode
                text: "Constant Power Factor"
                md_bg_color: '#005376'
                on_press: root.set_const_power_factor_mode()

        BoxLayout:
            id: param_box
            orientation: "vertical"
            size_hint: (1.0, 0.7)

        BoxLayout:
            size_hint: (1.0, 0.15)
            orientation: "horizontal"
            Button:
                text: "back"
                on_press: root.cancel()

            Button:
                text: "save"
                on_press: root.save()


<StorageConfigurationScreen>:
    name: "configure-storage"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"

            BoxLayout:
                orientation: "vertical"

                TextFieldOpenDSSName:
                    id: device_name
                    hint_text: "Device Name"
                    helper_text_mode: "on_error"
                    helper_text: "invalid name"

                BoxLayout:
                    orientation: "vertical"

                    TextFieldPositiveFloat:
                        id: power_input
                        hint_text: "Storage Device Power (kW)"

                    MDScrollView:
                        EditableSetList:
                            id: power_list

                BoxLayout:
                    orientation: "vertical"

                    TextFieldPositiveFloat:
                        id: duration_input
                        hint_text: "Storage Device Duration (hours)"

                    MDScrollView:
                        EditableSetList:
                            id: duration_list

            BoxLayout:
                orientation: "vertical"
                spacing: 10
                MDLabel:
                    text: "Select possible busses"
                    size_hint_y: None
                    height: 0
                MDScrollView:
                    size_hint: (1.0, 1.0)
                    MDList:
                        size_hint_y: None
                        height: 0
                        id: bus_list

                BoxLayout:
                    size_hint: (1.0, 0.06)
                    orientation: "horizontal"
                    MDLabel:
                        id: required_label
                        size_hint_y: None
                        height: 0
                        text: "required?"
                    MDSwitch:
                        id: required
                        size_hint_y: None
                        height: 0
                        active: False

                Button:
                    text: "Edit Control Parameters"
                    size_hint: (1.0, 0.06)
                    on_press: root.edit_control_params()

        BoxLayout:
            size_hint: (1.0, 0.15)
            orientation: "horizontal"
            Button:
                text: "back"
                on_press: root.cancel()

            Button:
                text: "save"
                on_press: root.save()


<LoadConfigurationScreen>:
    name: "load-config"

    BoxLayout:
        orientation: "vertical"

        Label:
            id: currMetriclabel
            text: "Defined Metrics"
            size_hint: 1.0, 0.05
            color: 0,0,0,1

        ScrollView:
            MDList:
                id: metriclist

        Button:
            text: "back"
            on_press: root.manager.current = 'ssim'

<MetricListItem>:

    bus: ' '

    IconRightWidget:
        id: trash_can
        icon: 'trash-can-outline'
        listItem: root

    IconLeftWidget:
        id: left_icon
        icon: 'chart-line'

<BusListItemWithCheckbox>:

    IconRightWidget:
        icon: root.icon

    LeftCheckbox:
        id: check
        listItem: root

<MetricConfigurationScreen>:
    name: "metric-config"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            #cols: 3
            orientation: "horizontal"

            BoxLayout:
                orientation: "vertical"

                Label:
                    text: "Class of Metrics to Configure"
                    size_hint: 1.0, 0.05
                    color: 0,0,0,1

                ScrollView:

                    MDList:
                        id: metriclist

                        TwoLineIconListItem:
                            text: "Voltage"
                            secondary_text: "set voltage targets by bus"
                            icon: "plus"
                            on_release: root.configure_voltage_metrics()

                        TwoLineIconListItem:
                            text: "Some other metric values"
                            secondary_text: "set ..."
                            icon: "plus"
                            on_release: root.configure_some_other_metrics()

            BoxLayout:
                orientation: "vertical"

                Label:
                    id: interlabel
                    text: "Metric Objects"
                    size_hint: 1.0, 0.05
                    color: 0,0,0,1

                BoxLayout:
                    orientation: "horizontal"
                    size_hint: None, None
                    size: self.parent.width, 10

                    Button:
                        id: btnSelectAll
                        text: "Select All"
                        size_hint: 0.5, None
                        size: self.parent.width, 10
                        on_release: root.select_all_metric_objects()
                        disabled: True

                    Button:
                        id: btnDeselectAll
                        text: "Deselect All"
                        size_hint: 0.5, None
                        size: self.parent.width, 10
                        on_release: root.deselect_all_metric_objects()
                        disabled: True

                ScrollView:
                    MDList:
                        id: interlist

            BoxLayout:
                orientation: "vertical"

                BoxLayout:
                    id: metricValueBox
                    orientation: "vertical"
                    size_hint: None, None
                    size: self.parent.width, 275
                    disabled: True

                    Label:
                        id: metriclabel
                        text: "Metric Settings"
                        size_hint: None, None
                        size: self.parent.width, 25
                        color: 0,0,0,1

                    TextFieldMultiFloat:
                        hint_text: "Limit Value"
                        id: limitText

                    TextFieldMultiFloat:
                        hint_text: "Objective Value"
                        id: objectiveText

                    Label:
                        id: senselabel
                        text: "Sense"
                        size_hint: None, None
                        size: self.parent.width, 25
                        color: 0,0,0,1

                    MDRaisedButton:
                        id: caller
                        text: "Sense"
                        size_hint: None, None
                        size: self.parent.width, 25
                        on_release: root.drop_sense_menu()

                    Button:
                        id: btnStore
                        text: "store"
                        size_hint: None, None
                        size: self.parent.width, 25
                        on_release: root.store_metrics()
                        disabled: True

                BoxLayout:
                    orientation: "vertical"

                    Label:
                        id: currMetriclabel
                        text: "Defined Metrics"
                        size_hint: 1.0, 0.05
                        color: 0,0,0,1

                    ScrollView:
                        MDList:
                            id: metriclist

        Button:
            text: "back"
            size_hint: 1.0, 0.05
            on_press: root.manager.current = 'ssim'

<RunSimulationScreen>:
    name: "run-sim"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            padding: 5

            BoxLayout:
                orientation: "vertical"
                padding: 5
                Label:
                    text: "Configurations that will be evaluated:"
                    size_hint_y: None
                    height: 50
                ScrollView:
                    canvas.before:
                        Color:
                            rgba: .5, .5, .5, 1
                        Line:
                            width: 2
                            rectangle: self.x, self.y, self.width, self.height
                    MDList:
                        id: config_list

            BoxLayout:
                orientation: "vertical"
                padding: 5
                spacing: 5
                Label:
                    text: "Total number of configurations 256 (128 completed)"
                    size_hint_y: None
                    height: 50
                Button: 

                    text: "View Saved Results"
                Button:
                    text: "View Summary"
                    on_press: root.open_results_summary()
                Button:
                    text: "Visualize Results"
                    on_release: root.open_visualize_results()
                Button: 
                    text: "Resume"
                Button:
                    text: "Remove Configuration"
                Button:
                    text: "Go"
                    on_press: root.run_configurations()

        Button:
            text: "back"
            size_hint_y: None
            height: 100
            on_press: root.manager.current = 'ssim'

<ResultsSummary@FloatLayout>:
            
    BoxLayout:
        orientation: "horizontal"
        padding: 5

        BoxLayout:
            id: summary_canvas
            size_hint_x: 1.5
            orientation: "vertical"
            padding: 5
            spacing: 5

        BoxLayout:
            orientation: "vertical"

            BoxLayout:
                orientation: "vertical"
                padding: 5
                
                BoxLayout: 
                    orientation: "horizontal"
                
                    BoxLayout:
                        orientation: "vertical"
                        Label:
                            size_hint_y: 0.1
                            text: "Select y-Display:"
                            color: 0,0,0,1
                        Label:
                            size_hint_y: 0.1
                            text: "Aggregate Metric:"
                            color: 0,0,0,1

                        ScrollView:
                            size_hint_y: 0.8
                            canvas.before:
                                Color:
                                    rgba: .5, .5, .5, 1
                                Line:
                                    width: 2
                                    rectangle: self.x, self.y, self.width, self.height
                            MDList:
                                id: metric_list_summary
                    
                    BoxLayout:
                        orientation: "vertical"
                        Label:
                            size_hint_y: 0.1
                            text: "Select x-Display:"
                            color: 0,0,0,1
                        Label:
                            size_hint_y: 0.1
                            text: "Configuration Number:"
                            color: 0,0,0,1

                        ScrollView:
                            size_hint_y: 0.8
                            canvas.before:
                                Color:
                                    rgba: .5, .5, .5, 1
                                Line:
                                    width: 2
                                    rectangle: self.x, self.y, self.width, self.height
                            MDList:
                                id: config_list_summary
            
            BoxLayout:
                orientation: "vertical"
                padding: 5
                spacing: 5
                Button:
                    text: "View Details"
                    on_press: root.open_results_detail()
                Button:
                    text: "Compare"
                    on_press: root.open_results_compare()
                Button:
                    text: "Save Figure"

<ResultsDetail@FloatLayout>:

    MDGridLayout:
        cols: 2
        rows: 1
        adaptive_height: True
        spacing: 25
        padding: 12
        pos_hint: {"center_x": 0.5, "center_y": 0.5}

        BoxLayout:
            id: detail_plot_canvas
            size_hint_x: 1.5
            orientation: "vertical"
            padding: 5
            spacing: 5
            Label:
                text: "Plot Displayed Here!"
                color: 0, 0, 0, 1

        BoxLayout:
            orientation: "vertical"
            Button:
                text: "Pass"

<ResultsVisualizeScreen>:
    name: "results-visualize"
    BoxLayout:
        orientation: "vertical"

        MDTabs:
            id: visualization_screens

            ResultsVisualizationTab:
                id: summary
                title: "Summary"

                ResultsSummary:
                    id: summary_page

            ResultsVisualizationTab:
                id: details
                title: "Details"

                ResultsDetail:
                    id: details_page

        BoxLayout:
            orientation: "horizontal"
            Button:
                text: "back"
                on_press: root.manager.current = "ssim"
                size_hint_y: None


<ResultsDetailScreen>:
    name: "results-detail"
    BoxLayout:
        orientation: "vertical"
        
        BoxLayout:
            orientation: "horizontal"
            padding: 5

            BoxLayout:
                id: detail_plot_canvas
                size_hint_x: 1.5
                orientation: "vertical"
                padding: 5
                spacing: 5
                Label:
                    text: "Plot Will Be Displayed Here!"
                    color: 0, 0, 0, 1

            BoxLayout:
                id: right_bar
                orientation: "vertical"
                Label:
                    size_hint_y: 0.1
                    text: "Select Configuration:"
                    color: 0,0,0,1

                MDRaisedButton:
                    id: config_list_detail
                    text: "Select Configuration ... "
                    size_hint_x: 1.0
                    # size: self.parent.width, 25
                    on_release: root.drop_config_menu()

                Label:
                    size_hint_y: 0.1
                    text: "Select Variable(s) to Plot:"
                    color: 0,0,0,1

                ScrollView:
                    size_hint_y: 0.8
                    canvas.before:
                        Color:
                            rgba: .5, .5, .5, 1
                        Line:
                            width: 2
                            rectangle: self.x, self.y, self.width, self.height
                    MDList:
                        id: variable_list_detail
                
                MDTextField:
                    id: detail_figure_title
                    hint_text: 'Enter custom title ...'

                MDTextField:
                    id: detail_figure_ylabel
                    hint_text: 'Enter custom Y-axis label ...'

                Button:
                    size_hint_y: 0.1
                    text: "Update Figure"
                    on_release: root.update_figure()
                Button:
                    size_hint_y: 0.1
                    text: "Clear Figure"
                    on_release: root.clear_figure()
                Button:
                    size_hint_y: 0.1
                    text: "Save Figure"
                    on_release: root.save_figure_options()

        Button:
            text: "back"
            size_hint_y: None
            on_press: root.manager.current = 'results-summary'

<ResultsSummaryScreen>:
    name: "results-summary"

    BoxLayout:
        orientation: "vertical"
        
        BoxLayout:
            orientation: "horizontal"
            padding: 5

            BoxLayout:
                id: summary_canvas
                size_hint_x: 1.5
                orientation: "vertical"
                padding: 5
                spacing: 5

            BoxLayout:
                orientation: "vertical"

                BoxLayout:
                    orientation: "vertical"
                    padding: 5
                    
                    BoxLayout: 
                        orientation: "horizontal"
                    
                        BoxLayout:
                            orientation: "vertical"
                            Label:
                                size_hint_y: 0.1
                                text: "Select y-Display:"
                                color: 0,0,0,1
                            Label:
                                size_hint_y: 0.1
                                text: "Aggregate Metric:"
                                color: 0,0,0,1

                            ScrollView:
                                size_hint_y: 0.8
                                canvas.before:
                                    Color:
                                        rgba: .5, .5, .5, 1
                                    Line:
                                        width: 2
                                        rectangle: self.x, self.y, self.width, self.height
                                MDList:
                                    id: metric_list_summary
                        
                        BoxLayout:
                            orientation: "vertical"
                            Label:
                                size_hint_y: 0.1
                                text: "Select x-Display:"
                                color: 0,0,0,1
                            Label:
                                size_hint_y: 0.1
                                text: "Configuration Number:"
                                color: 0,0,0,1

                            ScrollView:
                                size_hint_y: 0.8
                                canvas.before:
                                    Color:
                                        rgba: .5, .5, .5, 1
                                    Line:
                                        width: 2
                                        rectangle: self.x, self.y, self.width, self.height
                                MDList:
                                    id: config_list_summary
                
                BoxLayout:
                    orientation: "vertical"
                    padding: 5
                    spacing: 5
                    Button:
                        text: "View Details"
                        on_press: root.open_results_detail()
                    Button:
                        text: "Compare"
                        on_press: root.open_results_compare()
                    Button:
                        text: "Save Figure"

        Button:
            text: "back"
            size_hint_y: None
            on_press: root.manager.current = 'run-sim'
            
<ResultsCompareScreen>:
    name: "results-compare"
    BoxLayout:
        orientation: "vertical"
        
        BoxLayout:
            orientation: "horizontal"
            padding: 5

            BoxLayout:
                id: compare_canvas
                size_hint_x: 1.5
                orientation: "vertical"
                padding: 5
                spacing: 5
                Label:
                    text: "Comparison Plot Displayed Here!"
                    color: 0, 0, 0, 1

            BoxLayout:
                orientation: "vertical"
                Label:
                    size_hint_y: 0.1
                    text: "Configurations to Compare:"
                    color: 0,0,0,1

                ScrollView:
                    size_hint_y: 0.8
                    canvas.before:
                        Color:
                            rgba: .5, .5, .5, 1
                        Line:
                            width: 2
                            rectangle: self.x, self.y, self.width, self.height
                    MDList:
                        id: config_list_compare
                
                Button:
                    size_hint_y: 0.1
                    text: "Save Figure"

        Button:
            text: "back"
            size_hint_y: None
            on_press: root.manager.current = 'results-summary'


<EditableSetListItem>:

    IconRightWidget:
        id: delete
        icon: "trash-can-outline"


<ListItemWithCheckbox>:
    id: the_list_item
    markup: True

    LeftCheckbox:
        id: check
        active: True
        on_release:
            self.toggle_configuration_check(check)

    IconRightWidget:
        icon: 'trash-can-outline'
        theme_text_color: "Custom"
        text_color: 1, 0, 0, 1
        on_release:
            root.delete_item(the_list_item)

<SelectGridDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.dss"]

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)

<SelectSSIMTOMLDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.toml"]

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)

<NoGridPopupContent>:
    orientation: "vertical"
    Label:
        text: 'A grid model has not yet been selected.  Please return to the main screen and choose a grid model before attempting to set voltage metrics.'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2

    Button:
        id: mainScreenBtn
        text: 'Return to Main Screen'
        size_hint: 1, 0.2

<MessagePopupContent>:
    orientation: "vertical"
    Label:
        id: msg_label
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2

<MissingMetricValuesPopupContent>:
    orientation: "vertical"
    Label:
        text: 'Not all metric values have been properly specified.  Be sure to enter numbers for ""Limit"" and ""Objective"" and select a ""Sense"".'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2


<NoGridPopupContent>:
    Label:
        text: 'A grid model has not yet been selected.  Please return to the main screen and choose a grid model before continuing.'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2

<SaveFigureDialog>:
    text_input: text_input
    
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        Label:
            text: "Enter filename: "
            height: 30
        TextInput:
            id: text_input
            size_hint_y: None
            height: 30
            multiline: False

        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.png"]
            on_selection: text_input.text = self.selection and self.selection[0] or ''

    BoxLayout:
        size_hint_y: None
        height: 30
        Button:
            text: "Cancel"
            on_release: root.cancel()

        Button:
            text: "Save"
            on_release: root.save(filechooser.path, text_input.text)
