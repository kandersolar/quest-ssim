#:include common.kv


#:import MDBoxLayout kivymd.uix.boxlayout.MDBoxLayout
#:import MDDropdownMenu kivymd.uix.menu.MDDropdownMenu
#:import MDDropDownItem kivymd.uix.dropdownitem.MDDropDownItem

<SSimScreen>:
    name: 'ssim'
    bus_list: bus_list
    BoxLayout:
        orientation: "vertical"
        padding: 5
        spacing: 5

        BoxLayout:
            orientation: "horizontal"
            size_hint: (1.0, 0.5)

            Label:
                text: "Project Name:"
                color: C(hex_black)
                size_hint: (0.33, 1.0)

            TextInput:
                text: "unnamed"
                multiline: False
                valign: "center"

        Button:
            text: "save to file"
            on_press: root.write_toml()

        Button:
            text: "read from file"
            on_press: root.read_toml()

        Button:
            text: "select grid model"
            on_press: root.select_grid_model()

        Button:
            text: "select storage"
            on_press: root.open_der_configuration()

        Button:
            text: "configure loads"
            on_press: root.open_load_configuration()

        Button:
            text: "configure metrics"
            on_press: root.open_metric_configuration()

        Button:
            text: "Run"
            on_press: root.do_run_simulation()

        TextInput:
            id: bus_list
            multiline: True

<DERConfigurationScreen>:
    name: "der-config"
    on_enter: root.load_project_data()

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            padding: 5
            size_hint: (1.0, 0.8)

            BoxLayout:
                orientation: "vertical"
                padding: 5

                ScrollView:
                    size_hint: (1.0, 0.8)
                    MDList:
                        id: ess_list

                Button:
                    size_hint: (1.0, 0.1)
                    text: "New Storage"
                    on_press: root.new_storage()

                Button:
                    size_hint: (1.0, 0.1)
                    text: "Delete Storage"

            Button:
                text: "list of PV"


        BoxLayout:
            orientation: "horizontal"
            padding: 5
            spacing: 5
            size_hint: (1.0, 0.2)

            Button:
                height: 10
                text: "back"
                on_press: root.manager.current = 'ssim'

            Button:
                height: 10
                text: "save"
                # Might need something different here to handle the
                on_press: root.manager.current = 'ssim'


<BusListItem>:

    LeftCheckBox:
        id: selected

<StorageControlConfigurationScreen>:
    name: "configure-storage-controls"
    on_enter: self.set_mode_label_text()

    BoxLayout:
        orientation: "vertical"

        TextFieldPositivePercentage:
            id: min_soc
            hint_text: "Minimum State of Charge (%)"

        TextFieldPositivePercentage:
            id: max_soc
            hint_text: "Maximum State of Charge (%)"

        TextFieldPositivePercentage:
            id: init_soc
            hint_text: "Initial State of Charge (%)"

        Label:
            id: mode_label
            markup: True
            text: "Select a control mode for this storage asset:"
            color: C(hex_black)
            size_hint: (1.0, 0.05)

        BoxLayout:
            orientation: "horizontal"
            size_hint: (1.0, 0.2)

            MDRaisedButton:
                id: droop_mode
                text: "Droop"
                md_bg_color: '#005376'
                on_press: root.set_droop_mode()

            MDRaisedButton:
                id: vv_mode
                text: "Volt-Var"
                md_bg_color: '#005376'
                on_press: root.set_volt_var_mode()

            MDRaisedButton:
                id: vw_mode
                text: "Volt-Watt"
                md_bg_color: '#005376'
                on_press: root.set_volt_watt_mode()

            MDRaisedButton:
                id: var_watt_mode
                text: "Var-Watt"
                md_bg_color: '#005376'
                on_press: root.set_var_watt_mode()

            MDRaisedButton:
                id: vv_vw_mode
                text: "Volt-Var & Volt-Watt"
                md_bg_color: '#005376'
                on_press: root.set_volt_var_and_volt_watt_mode()

            MDRaisedButton:
                id: const_pf_mode
                text: "Constant Power Factor"
                md_bg_color: '#005376'
                on_press: root.set_const_power_factor_mode()

        BoxLayout:
            id: param_box
            orientation: "vertical"
            size_hint: (1.0, 0.7)

        BoxLayout:
            size_hint: (1.0, 0.15)
            orientation: "horizontal"
            Button:
                text: "back"
                on_press: root.cancel()

            Button:
                text: "save"
                on_press: root.save()


<StorageConfigurationScreen>:
    name: "configure-storage"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"

            BoxLayout:
                orientation: "vertical"

                TextFieldOpenDSSName:
                    id: device_name
                    hint_text: "Device Name"
                    helper_text_mode: "on_error"
                    helper_text: "invalid name"

                BoxLayout:
                    orientation: "vertical"

                    TextFieldPositiveFloat:
                        id: power_input
                        hint_text: "Storage Device Power (kW)"

                    MDScrollView:
                        EditableSetList:
                            id: power_list

                BoxLayout:
                    orientation: "vertical"

                    TextFieldPositiveFloat:
                        id: duration_input
                        hint_text: "Storage Device Duration (hours)"

                    MDScrollView:
                        EditableSetList:
                            id: duration_list

            BoxLayout:
                orientation: "vertical"
                spacing: 10
                MDLabel:
                    text: "Select possible busses"
                    size_hint_y: None
                    height: 0
                MDScrollView:
                    size_hint: (1.0, 1.0)
                    MDList:
                        size_hint_y: None
                        height: 0
                        id: bus_list

                BoxLayout:
                    size_hint: (1.0, 0.06)
                    orientation: "horizontal"
                    MDLabel:
                        id: required_label
                        size_hint_y: None
                        height: 0
                        text: "required?"
                    MDSwitch:
                        id: required
                        size_hint_y: None
                        height: 0
                        active: False

                Button:
                    text: "Edit Control Parameters"
                    size_hint: (1.0, 0.06)
                    on_press: root.edit_control_params()

        BoxLayout:
            size_hint: (1.0, 0.15)
            orientation: "horizontal"
            Button:
                text: "back"
                on_press: root.cancel()

            Button:
                text: "save"
                on_press: root.save()


<LoadConfigurationScreen>:
    name: "load-config"

    BoxLayout:
        orientation: "vertical"

        Label:
            id: currMetriclabel
            text: "Defined Metrics"
            size_hint: 1.0, 0.05
            color: 0,0,0,1

        ScrollView:
            MDList:
                id: metriclist

        Button:
            text: "back"
            on_press: root.manager.current = 'ssim'

<MetricListItem>:

    bus: ' '

    IconRightWidget:
        id: trash_can
        icon: 'trash-can-outline'
        listItem: root

    IconLeftWidget:
        id: left_icon
        icon: 'chart-line'

<BusListItemWithCheckbox>:

    IconRightWidget:
        icon: root.icon

    LeftCheckbox:
        id: check
        listItem: root

<MetricConfigurationScreen>:
    name: "metric-config"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            #cols: 3
            orientation: "horizontal"

            BoxLayout:
                orientation: "vertical"

                Label:
                    text: "Class of Metrics to Configure"
                    size_hint: 1.0, 0.05
                    color: 0,0,0,1

                ScrollView:

                    MDList:
                        id: metriclist

                        TwoLineIconListItem:
                            text: "Voltage"
                            secondary_text: "set voltage targets by bus"
                            icon: "plus"
                            on_release: root.configure_voltage_metrics()

                        TwoLineIconListItem:
                            text: "Some other metric values"
                            secondary_text: "set ..."
                            icon: "plus"
                            on_release: root.configure_some_other_metrics()

            BoxLayout:
                orientation: "vertical"

                Label:
                    id: interlabel
                    text: "Metric Objects"
                    size_hint: 1.0, 0.05
                    color: 0,0,0,1

                BoxLayout:
                    orientation: "horizontal"
                    size_hint: None, None
                    size: self.parent.width, 10

                    Button:
                        id: btnSelectAll
                        text: "Select All"
                        size_hint: 0.5, None
                        size: self.parent.width, 10
                        on_release: root.select_all_metric_objects()
                        disabled: True

                    Button:
                        id: btnDeselectAll
                        text: "Deselect All"
                        size_hint: 0.5, None
                        size: self.parent.width, 10
                        on_release: root.deselect_all_metric_objects()
                        disabled: True

                ScrollView:
                    MDList:
                        id: interlist

            BoxLayout:
                orientation: "vertical"

                BoxLayout:
                    id: metricValueBox
                    orientation: "vertical"
                    size_hint: None, None
                    size: self.parent.width, 275
                    disabled: True

                    Label:
                        id: metriclabel
                        text: "Metric Settings"
                        size_hint: None, None
                        size: self.parent.width, 25
                        color: 0,0,0,1

                    BoxLayout:
                        id: metricSenseBox
                        orientation: "horizontal"
                        disabled: True

                        MDRaisedButton:
                            id: min_btn
                            selected: False
                            text: "Minimize"
                            size_hint: 0.33, None
                            #size: self.parent.width, 25
                            on_release: root.set_minimize_sense()

                        MDRaisedButton:
                            id: max_btn
                            selected: False
                            text: "Maximize"
                            size_hint: 0.33, None
                            #size: self.parent.width, 25
                            on_release: root.set_maximize_sense()

                        MDRaisedButton:
                            id: seek_btn
                            selected: False
                            text: "Seek Value"
                            size_hint: 0.33, None
                            #size: self.parent.width, 25
                            on_release: root.set_seek_value_sense()

                    TextFieldMultiFloat:
                        hint_text: "Lower Limit Value"
                        id: lowerLimitText

                    TextFieldMultiFloat:
                        hint_text: "Objective Value"
                        id: objectiveText

                    TextFieldMultiFloat:
                        hint_text: "Upper Limit Value"
                        id: upperLimitText

                    Button:
                        id: btnStore
                        text: "store"
                        size_hint: None, None
                        size: self.parent.width, 25
                        on_release: root.store_metrics()
                        disabled: True

                BoxLayout:
                    orientation: "vertical"

                    Label:
                        id: currMetriclabel
                        text: "Defined Metrics"
                        size_hint: 1.0, 0.05
                        color: 0,0,0,1

                    ScrollView:
                        MDList:
                            id: metriclist

        Button:
            text: "back"
            size_hint: 1.0, 0.05
            on_press: root.manager.current = 'ssim'

<RunSimulationScreen>:
    name: "run-sim"

    BoxLayout:
        orientation: "vertical"

        BoxLayout:
            orientation: "horizontal"
            padding: 5

            BoxLayout:
                orientation: "vertical"
                padding: 5
                Label:
                    text: "Configurations that will be evaluated:"
                    size_hint_y: None
                    height: 50
                ScrollView:
                    canvas.before:
                        Color:
                            rgba: .5, .5, .5, 1
                        Line:
                            width: 2
                            rectangle: self.x, self.y, self.width, self.height
                    MDList:
                        id: config_list

            BoxLayout:
                orientation: "vertical"
                padding: 5
                spacing: 5
                Label:
                    text: "Total number of configurations 256 (128 completed)"
                    size_hint_y: None
                    height: 50
                Button:
                    text: "View Saved Results"
                Button:
                    text: "Resume"
                Button:
                    text: "Remove Configuration"
                Button:
                    text: "Go"

        Button:
            text: "back"
            size_hint_y: None
            height: 100
            on_press: root.manager.current = 'ssim'


<EditableSetListItem>:

    IconRightWidget:
        id: delete
        icon: "trash-can-outline"


<ListItemWithCheckbox>:
    id: the_list_item
    markup: True

    LeftCheckbox:
        id: check
        active: True

    IconRightWidget:
        icon: 'trash-can-outline'
        theme_text_color: "Custom"
        text_color: 1, 0, 0, 1
        on_release:
            root.delete_item(the_list_item)

<SelectGridDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.dss"]

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)

<LoadSSIMTOMLDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.toml"]

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)

<SaveSSIMTOMLDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: "."
            filters: ["*.toml"]
            dirselect: True
            on_selection: root.manage_filename_field()

        BoxLayout:
            size_hint_y: None
            height: 30
            orientation: "horizontal"

            Label:
                text: "Filename:"
                size_hint: 0.1, 1.0

            TextInput:
                id: filenamefield

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Save"
                on_release: root.save(filechooser.selection, filenamefield.text)

<NoGridPopupContent>:
    orientation: "vertical"
    Label:
        text: 'A grid model has not yet been selected.  Please return to the main screen and choose a grid model before attempting to set voltage metrics.'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2

    Button:
        id: mainScreenBtn
        text: 'Return to Main Screen'
        size_hint: 1, 0.2

<MessagePopupContent>:
    orientation: "vertical"
    Label:
        id: msg_label
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2

<MissingMetricValuesPopupContent>:
    orientation: "vertical"
    Label:
        text: 'Not all metric values have been properly specified.  Be sure to enter numbers for ""Limit"" and ""Objective"" and select a ""Sense"".'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2


<NoGridPopupContent>:
    Label:
        text: 'A grid model has not yet been selected.  Please return to the main screen and choose a grid model before continuing.'
        text_size: self.width, None
        height: self.texture_size[1]

    Button:
        id: dismissBtn
        text: 'Dismiss'
        size_hint: 1, 0.2
